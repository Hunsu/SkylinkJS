/*! skylinkjs - v1.0.0 - 2015-10-28 */
var DataChannel=function(channel){"use strict";var objectRef=(channel.label,channel);Event.mixin(this),objectRef.onopen=function(event){this._trigger("connected",event)},objectRef.onmessage=function(event){this._trigger("message",event)},objectRef.onclose=function(event){this._trigger("disconnected",event)},objectRef.onerror=function(event){this._trigger("error",event)}};DataChannel.prototype.disconnect=function(){objectRef.close()};var SkylinkEvent={on:function(event,callback){return this.listeners.on[event]=this.listeners.on[event]||[],this.listeners.on[event].push(callback),this},off:function(event,callback){return"undefined"==typeof event&&(this.listeners.on={},this.listeners.once={}),"undefined"==typeof callback?(this.listeners.on[event]=[],this.listeners.once[event]=[]):(this.listeners.on[event]&&this._removeListener(this.listeners.on[event],callback),this.listeners.once[event]&&this._removeListener(this.listeners.once[event],callback)),this},once:function(event,callback){return this.listeners.once[event]=this.listeners.once[event]||[],this.listeners.once[event].push(callback),this},_trigger:function(event){var args=Array.prototype.slice.call(arguments,1);if(this.listeners.on[event])for(var i=0;i<this.listeners.on[event].length;i++)this.listeners.on[event][i].apply(this,args);if(this.listeners.once[event])for(var j=0;j<this.listeners.once[event].length;j++)this.listeners.once[event][j].apply(this,args),this.listeners.once[event].splice(j,1),j--;return this},_removeListener:function(listeners,listener){for(var i=0;i<listeners.length;i++)if(listeners[i]===listener)return void listeners.splice(i,1)},_mixin:function(object){for(var methods=["on","off","once","_trigger","_removeListener"],i=0;i<methods.length;i++)SkylinkEvent.hasOwnProperty(methods[i])&&("function"==typeof object?object.prototype[methods[i]]=SkylinkEvent[methods[i]]:object[methods[i]]=SkylinkEvent[methods[i]]);return object.listeners={on:{},once:{}},object}},Global={_signalingChannelOpen:!1,_signalingServer:null},log={};"function"!=typeof window.console.debug?window.console.newDebug=window.console.log:window.console.newDebug=window.console.debug,"function"!=typeof window.console.trace?window.console.newTrace=window.console.log:window.console.newTrace=window.console.trace;var LogKey="Skylink - ",Debugger={level:2,trace:!1,store:!1,logs:[],console:{log:window.console.log.bind(window.console,LogKey+"%s> %s"),error:window.console.error.bind(window.console,LogKey+"%s> %s"),info:window.console.info.bind(window.console,("safari"===window.webrtcDetectedBrowser?"INFO: ":"")+LogKey+"%s> %s"),warn:window.console.warn.bind(window.console,LogKey+"%s> %s"),debug:window.console.newDebug.bind(window.console,("function"!=typeof window.console.debug?"DEBUG: ":"")+LogKey+"%s> %s")},traceTemplate:{log:"==LOG== "+LogKey+"%s",error:"==ERROR== "+LogKey+"%s",info:"==INFO== "+LogKey+"%s",warn:"==WARN== "+LogKey+"%s",debug:"==DEBUG== "+LogKey+"%s"},applyConsole:function(type){var args=Array.prototype.slice.call(arguments);return args.shift(),this.store&&logs.push(type,args,new Date),this.trace?window.console.newTrace.bind(window.console,this.traceTemplate[type]):this.console[type]},setLevel:function(inputLevel){inputLevel>3?log.debug=this.applyConsole("debug"):log.debug=function(){},inputLevel>2?log.log=this.applyConsole("log"):log.log=function(){},inputLevel>1?log.info=this.applyConsole("info"):log.info=function(){},inputLevel>0?log.warn=this.applyConsole("warn"):log.warn=function(){},inputLevel>-1?log.error=this.applyConsole("error"):log.error=function(){},this.level=inputLevel},configure:function(options){options=options||{},Debugger.store=!!options.store,Debugger.trace=!!options.trace,Debugger.setLevel("number"==typeof options.level?options.level:2)}};Debugger.setLevel(4);var Socket=function(options){"use strict";var self=this;options||(options={}),self._signalingServer=options.server||"signaling.temasys.com.sg",self._socketPorts={http:options.httpPorts||[80,3e3],https:options.httpsPorts||[443,3443]},self._type=options.type||"WebSocket",self._socketTimeout=options.socketTimeout||2e4,self._isSecure=options.secure||!1,self._readyState="constructed",self._isXDR=!1,self._signalingServerProtocol=window.location.protocol.substring(0,window.location.protocol.length-1),self._socketMessageTimeout=null,self._socketMessageQueue=[],self.SOCKET_ERROR={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},self.SOCKET_FALLBACK={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},self._currentSignalingServerPort=null,self._channelOpen=!1,self._objectRef=null,self._firstConnect=!1,self._socketOptions={reconnection:!0,reconnectionAttempts:2,forceNew:!0},SkylinkEvent._mixin(self)};Socket.prototype._assignPort=function(){var self=this,ports=self._socketPorts[self._signalingServerProtocol],currentPortIndex=ports.indexOf(self._currentSignalingServerPort);-1===currentPortIndex?self._currentSignalingServerPort=ports[0]:currentPortIndex>-1&&currentPortIndex<ports.length-1?self._currentSignalingServerPort=ports[currentPortIndex+1]:"WebSocket"===self._type?(self._type="Polling",self._currentSignalingServerPort=ports[0]):"Polling"===self._type&&(self._socketOptions.reconnectionAttempts=4,self._socketOptions.reconectionDelayMax=1e3)},Socket.prototype.connect=function(){var self=this;self.disconnect(),self._assignPort();var url=self._signalingServerProtocol+"://"+self._signalingServer+":"+self._currentSignalingServerPort;"WebSocket"===self._type?self._socketOptions.transports=["websocket"]:"Polling"===self._type&&(self._socketOptions.transports=["xhr-polling","jsonp-polling","polling"]),self._objectRef=io.connect(url,self._socketOptions),self._firstConnect||self._bindHandlers()},Socket.prototype.disconnect=function(){var self=this;self._channelOpen&&(self._objectRef&&(self._objectRef.removeAllListeners("connect"),self._objectRef.removeAllListeners("disconnect"),self._objectRef.removeAllListeners("reconnect"),self._objectRef.removeAllListeners("reconnect_attempt"),self._objectRef.removeAllListeners("reconnecting"),self._objectRef.removeAllListeners("reconnect_error"),self._objectRef.removeAllListeners("reconnect_failed"),self._objectRef.removeAllListeners("connect_error"),self._objectRef.removeAllListeners("connect_timeout"),self._objectRef.removeAllListeners("message"),self._channelOpen=!1,self._objectRef.disconnect()),self._trigger("channelClose"))},Socket.prototype._bindHandlers=function(){var self=this;self._firstConnect=!1,self._objectRef.on("connect",function(){self._channelOpen=!0,self._readyState="connected",self._trigger("connected")}),self._objectRef.on("error",function(error){self._channelOpen=!1,self._readyState="error",self._trigger("error",error)}),self._objectRef.on("disconnect",function(){self._channelOpen=!1,self._readyState="disconnected",self._trigger("disconnected")}),self._objectRef.on("reconnect",function(attempt){self._channelOpen=!0,self._readyState="reconnect",self._trigger("reconnect",attempt)}),self._objectRef.on("reconnect_attempt",function(){self._channelOpen=!1,self._readyState="reconnect_attempt",self._trigger("reconnect_attempt")}),self._objectRef.on("reconnecting",function(attempt){self._readyState="reconnecting",self._trigger("reconnecting",attempt)}),self._objectRef.on("reconnect_error",function(error){self._channelOpen=!1,self._readyState="reconnect_error",self._trigger("reconnect_error",error)}),self._objectRef.on("reconnect_failed",function(){self._channelOpen=!1,self._readyState="reconnect_failed",self._trigger("reconnect_failed"),self.connect()}),self._objectRef.on("connect_error",function(error){self._channelOpen=!1,self._readyState="connect_error",self._trigger("connect_error",error)}),self._objectRef.on("connect_timeout",function(error){self._channelOpen=!1,self._readyState="connect_timeout",self._trigger("connect_timeout",error)}),self._objectRef.on("message",function(){})};var Stream=function(stream){"use strict";var self=this;if(log.debug("Passed object for constructing new Stream object",stream),"object"!=typeof stream||null===stream)throw new Error("Object passed in for constructing a new Stream object is invalid");self._streamSettings={audio:!1,video:!1,MediaStreamConstraints:{}},self._ref=null,self._audioTracks=[],self._videoTracks=[],Event.mixin(self),"function"==typeof stream.getAudioTracks&&"function"==typeof stream.getVideoTracks?self._construct(stream):(("object"==typeof stream.audio||"boolean"==typeof stream.audio)&&(self._streamSettings.audio=stream.audio),("object"==typeof stream.video||"boolean"==typeof stream.video)&&(self._streamSettings.video=stream.video),self._streamSettings.MediaStreamConstraints=self._parseConstraints(self._streamSettings),window.navigator.getUserMedia(self._streamSettings.MediaStreamConstraints,function(streamObj){self._construct(streamObj)},function(error){throw error}))};Stream.prototype._parseConstraints=function(constaints){var mediaStreamConstraints={audio:!1,video:!1};if(constraints.audio&&("object"==typeof constraints.audio?(mediaStreamConstraints.audio={},Array.isArray(constraints.audio.optional)&&(mediaStreamConstraints.audio.optional=constraints.audio.optional)):mediaStreamConstraints.audio=!0),constraints.video&&"object"==typeof constraints.video){mediaStreamConstraints.video={},Array.isArray(constraints.video.optional)&&(mediaStreamConstraints.video.optional=constraints.video.optional);var useOlderSpecsWHA=!0;("firefox"===window.webrtcDetectedBrowser||window.webrtcDetectedVersion>38)&&(useOlderSpecsWHA=!1);var checkSpecsWHAVal=function(key,type,value){var error=null,setVal=!1;if("aspectRatio"===key){if("string"==typeof value)try{var ratio=value.split(":"),w=parseInt(ratio[0],10),h=parseInt(ratio[1],10);"number"==typeof w&&w>0&&"number"==typeof h&&h>0&&(setVal=!0)}catch(errorObj){error=errorObj}}else"number"==typeof value&&value>-1&&(setVal=!0);if(setVal)if(useOlderSpecsWHA){var newKey=key[0].toUpperCase()+key.substring(1,key.length);"object"!=typeof mediaStreamConstraints.video.mandatory&&(mediaStreamConstraints.video.mandatory={}),mediaStreamConstraints.video.mandatory[type+newKey]=value}else mediaStreamConstraints.video[key][type]=value;else log.debug("Not setting string for video."+key+"."+type+" as invalid or not found",value,error)},convertToOlderSpecsWHA=function(key,specs){"object"==typeof specs&&(checkSpecsWHAVal(key,"min",key.min),checkSpecsWHAVal(key,"max",key.max))};convertToOlderSpecsWHA("height",constraints.video.height),convertToOlderSpecsWHA("width",constraints.video.width),convertToOlderSpecsWHA("aspectRatio",constraints.video.aspectRatio)}return mediaStreamConstraints},Stream.prototype._construct=function(stream){};var StreamTrack=function(mstrack){"use strict";var self=this;return self.type=mstrack.kind,self.readyState="streaming",self.muted=!mstrack.enabled,self._objectRef=null,Event.mixin(self),"object"!=typeof mstrack||null===mstrack?Util["throw"](new Error("Provided track object is not a MediaStreamTrack object")):void self._appendListeners(mstrack)};StreamTrack.prototype._appendListeners=function(mstrack){var self=this;self._objectRef=mstrack,setTimeout(function(){self.trigger("streaming",{})},1e3)},StreamTrack.prototype.mute=function(){var self=this;self._objectRef.enabled=!1,self.muted=!0,self.trigger("mute",{})},StreamTrack.prototype.unmute=function(){var self=this;self._objectRef.enabled=!0,self.muted=!1,self.trigger("unmute",{})},StreamTrack.prototype.stop=function(){var self=this;try{self._objectRef.stop()}catch(error){return Util["throw"](new Error("The current browser implementation does not support MediaStreamTrack.stop()"))}self.readyState="stopped",self.trigger("stopped",{})};var Util={};Util.generateUUID=function(){var d=(new Date).getTime(),uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+16*Math.random())%16|0;return d=Math.floor(d/16),("x"==c?r:7&r|8).toString(16)});return uuid},Util.throwError=function(error){if("IE"!==window.webrtcDetectedBrowser)throw error};