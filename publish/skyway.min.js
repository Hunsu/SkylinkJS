/*! skywayjs - v0.3.1 - 2014-08-07 */
(function(){function Skyway(){return this instanceof Skyway?(this.VERSION="0.3.1",this.REGIONAL_SERVER={US1:"us1",US2:"us2",SG:"sg",EU:"eu"},this.ICE_CONNECTION_STATE={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},this.PEER_CONNECTION_STATE={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",HAVE_LOCAL_PRANSWER:"have-local-pranswer",HAVE_REMOTE_PRANSWER:"have-remote-pranswer",ESTABLISHED:"established",CLOSED:"closed"},this.CANDIDATE_GENERATION_STATE={GATHERING:"gathering",DONE:"done"},this.HANDSHAKE_PROGRESS={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer"},this.DATA_CHANNEL_STATE={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",NEW:"new",LOADED:"loaded",ERROR:"error"},this.SYSTEM_ACTION={WARNING:"warning",REJECT:"reject",CLOSED:"close"},this.READY_STATE_CHANGE={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},this.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},this.DATA_TRANSFER_STATE={UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted"},this.DATA_TRANSFER_DATA_TYPE={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob"},this.SIG_TYPE={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:this.HANDSHAKE_PROGRESS.ENTER,WELCOME:this.HANDSHAKE_PROGRESS.WELCOME,OFFER:this.HANDSHAKE_PROGRESS.OFFER,ANSWER:this.HANDSHAKE_PROGRESS.ANSWER,CANDIDATE:"candidate",BYE:"bye",CHAT:"chat",REDIRECT:"redirect",ERROR:"error",INVITE:"invite",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",MUTE_VIDEO:"muteVideoEvent",MUTE_AUDIO:"muteAudioEvent",PUBLIC_MSG:"public",PRIVATE_MSG:"private"},this.LOCK_ACTION={LOCK:"lock",UNLOCK:"unlock",STATUS:"check"},this.VIDEO_RESOLUTION={QVGA:{width:320,height:180},VGA:{width:640,height:360},HD:{width:1280,height:720},FHD:{width:1920,height:1080}},this._path=null,this._serverPath="//api.temasys.com.sg",this._serverRegion=null,this._roomServer=null,this._apiKey=null,this._defaultRoom=null,this._selectedRoom=null,this._roomStart=null,this._roomDuration=null,this._roomCredentials=null,this._key=null,this._socket=null,this._socketVersion=null,this._user=null,this._room=null,this._peerConnections=[],this._peerInformations=[],this._dataChannels=[],this._dataChannelPeers=[],this._readyState=0,this._channel_open=!1,this._in_room=!1,this._uploadDataTransfers={},this._uploadDataSessions={},this._downloadDataTransfers={},this._downloadDataSessions={},this._dataTransfersTimeout={},this._chunkFileSize=49152,this._mozChunkFileSize=16384,this._enableIceTrickle=!0,this._debug=!1,this._userDefinedMediaConstraints=null,this._streamSettings={audio:!0,video:!0},this._requestServerInfo=function(method,url,callback,params){var xhr=new window.XMLHttpRequest;xhr.onreadystatechange=function(){this.readyState===this.DONE&&(200!==this.status,callback(this.status,JSON.parse(this.response||"{}")))},xhr.open(method,url,!0),params?(xhr.setRequestHeader("Content-type","application/json;charset=UTF-8"),xhr.send(JSON.stringify(params))):xhr.send()},this._parseInfo=function(info,self){return info.pc_constraints||info.offer_constraints?(self._key=info.cid,self._user={id:info.username,token:info.userCred,timeStamp:info.timeStamp,displayName:info.displayName,apiOwner:info.apiOwner,streams:[]},self._room={id:info.room_key,token:info.roomCred,start:info.start,len:info.len,signalingServer:{ip:info.ipSigserver,port:info.portSigserver,protocol:info.protocol},pcHelper:{pcConstraints:JSON.parse(info.pc_constraints),pcConfig:null,offerConstraints:JSON.parse(info.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}},self._readyState=2,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.COMPLETED)):void self._trigger("readyStateChange",this.READY_STATE_CHANGE.ERROR,info.info)},void(this._loadInfo=function(self){return window.io?window.XMLHttpRequest?window.RTCPeerConnection?self._path?(self._readyState=1,self._trigger("readyStateChange",self.READY_STATE_CHANGE.LOADING),void self._requestServerInfo("GET",self._path,function(status,response){return 200!==status?(self._readyState=0,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,"XMLHttpRequest status not OK")):void self._parseInfo(response,self)})):void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,"No API Path is found"):void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,"WebRTC not available"):void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,"XMLHttpRequest not available"):void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,"Socket.io not found")})):new Skyway}this.Skyway=Skyway,Skyway.prototype.on=function(eventName,callback){"function"==typeof callback&&(this._events[eventName]=this._events[eventName]||[],this._events[eventName].push(callback))},Skyway.prototype.off=function(eventName,callback){if(void 0===callback)return void(this._events[eventName]=[]);for(var arr=this._events[eventName],l=arr.length,i=0;l>i;i++)if(arr[i]===callback){arr.splice(i,1);break}},Skyway.prototype._trigger=function(eventName){var args=Array.prototype.slice.call(arguments),arr=this._events[eventName];args.shift();for(var e in arr)if(arr[e].apply(this,args)===!1)break},Skyway.prototype.init=function(options){var apiKey,room,defaultRoom,startDateTime,duration,credentials,roomserver=this._serverPath,region="us1",iceTrickle=!0;"string"==typeof options?(apiKey=options,defaultRoom=apiKey,room=apiKey):(apiKey=options.apiKey,roomserver=options.roomServer||roomserver,roomserver=roomserver.lastIndexOf("/")===roomserver.length-1?roomserver.substring(0,str.length-1):roomserver,region=options.region||region,defaultRoom=options.defaultRoom||apiKey,room=options.room||defaultRoom,iceTrickle=void 0!==typeof options.iceTrickle?options.iceTrickle:iceTrickle,options.credentials&&(startDateTime=options.credentials.startDateTime||(new Date).toISOString(),duration=options.credentials.duration||200,credentials=options.credentials.credentials)),this._readyState=0,this._trigger("readyStateChange",this.READY_STATE_CHANGE.INIT),this._apiKey=apiKey,this._roomServer=roomserver,this._defaultRoom=defaultRoom,this._selectedRoom=room,this._serverRegion=region,this._enableIceTrickle=iceTrickle,this._path=roomserver+"/api/"+apiKey+"/"+room,credentials&&(this._roomStart=startDateTime,this._roomDuration=duration,this._roomCredentials=credentials,this._path+=credentials?"/"+startDateTime+"/"+duration+"?&cred="+credentials:""),this._path+=(this._path.indexOf("?&")>-1?"&":"?&")+"rg="+region,this._loadInfo(this)},Skyway.prototype._reinit=function(callback,options){var startDateTime,duration,credentials,self=this,apiKey=options.apiKey||self._apiKey,roomserver=options.roomServer||self._roomServer;roomserver=roomserver.lastIndexOf("/")===roomserver.length-1?roomserver.substring(0,str.length-1):roomserver;var region=options.region||self._serverRegion,defaultRoom=options.defaultRoom||self._defaultRoom,room=options.room||defaultRoom,iceTrickle=void 0!==typeof options.iceTrickle?options.iceTrickle:self._enableIceTrickle;options.credentials?(startDateTime=options.credentials.startDateTime||(new Date).toISOString(),duration=options.credentials.duration||500,credentials=options.credentials.credentials||self._roomCredentials):self._roomCredentials&&(startDateTime=self._roomStart,duration=self._roomDuration,credentials=self._roomCredentials),self._apiKey=apiKey,self._roomServer=roomserver,self._defaultRoom=defaultRoom,self._selectedRoom=room,self._serverRegion=region,self._enableIceTrickle=iceTrickle,self._path=roomserver+"/api/"+apiKey+"/"+room,credentials&&(self._roomStart=startDateTime,self._roomDuration=duration,self._roomCredentials=credentials,self._path+=credentials?"/"+startDateTime+"/"+duration+"?&cred="+credentials:""),self._path+=(self._path.indexOf("?&")>-1?"&":"?&")+"rg="+region,self._requestServerInfo("GET",self._path,function(status,response){if(200!==status)return self._readyState=0,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,"XMLHttpRequest status not OK");var info=response;try{self._key=info.cid,self._user={id:info.username,token:info.userCred,timeStamp:info.timeStamp,displayName:info.displayName,apiOwner:info.apiOwner,streams:[]},self._room={id:info.room_key,token:info.roomCred,start:info.start,len:info.len,signalingServer:{ip:info.ipSigserver,port:info.portSigserver,protocol:info.protocol},pcHelper:{pcConstraints:JSON.parse(info.pc_constraints),pcConfig:null,offerConstraints:JSON.parse(info.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}},callback()}catch(err){return self._readyState=0,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,err.name||err.message?err.name+": "+err.message:err)}})},Skyway.prototype.setDebug=function(debug){this._debug=debug},Skyway.prototype.setUser=function(displayName,data){var self=this,params={type:self.SIG_TYPE.UPDATE_USER,mid:self._user.sid,rid:self._room.id};if("string"==typeof displayName)self._user.info.displayName=displayName,params.displayName=displayName;else{if("object"!=typeof displayName)return;self._user.info.data=displayName,params.data=displayName}"object"==typeof data&&(self._user.info.data=data,params.data=displayName),self._in_room&&(setTimeout(function(){self._sendMessage(params)},1e3),this._trigger("userUpdated",self._user.info))},Skyway.prototype.getUser=function(){return this._user.info},Skyway.prototype.getPeer=function(peerId){return peerId?this._peerInformations[peerId]:void 0},Skyway.prototype._events={channelOpen:[],channelClose:[],channelMessage:[],channelError:[],joinedRoom:[],readyStateChange:[],handshakeProgress:[],candidateGenerationState:[],peerConnectionState:[],iceConnectionState:[],mediaAccessError:[],mediaAccessSuccess:[],chatMessage:[],peerJoined:[],peerUpdated:[],peerLeft:[],presenceChanged:[],addPeerStream:[],removePeerStream:[],roomLock:[],userUpdated:[],addContact:[],removeContact:[],invitePeer:[],dataChannelState:[],dataTransferState:[],systemAction:[],privateMessage:[],publicMessage:[]},Skyway.prototype.sendChatMsg=function(chatMsg,targetpeerId){var msg_json={cid:this._key,data:chatMsg,mid:this._user.sid,sender:this._user.sid,rid:this._room.id,type:this.SIG_TYPE.CHAT};targetpeerId&&(msg_json.target=targetpeerId),this._sendMessage(msg_json),this._trigger("chatMessage",chatMsg,this._user.sid,!!targetpeerId)},Skyway.prototype.sendDataChannelChatMsg=function(chatMsg,targetpeerId){var msg_json={cid:this._key,data:chatMsg,mid:this._user.sid,sender:this._user.sid,rid:this._room.id,type:this.SIG_TYPE.CHAT};if(targetpeerId&&(msg_json.target=targetpeerId),targetpeerId)this._dataChannels.hasOwnProperty(targetpeerId)&&this._sendDataChannel(targetpeerId,["CHAT","PRIVATE",this._user.sid,chatMsg]);else for(var peerId in this._dataChannels)this._dataChannels.hasOwnProperty(peerId)&&this._sendDataChannel(peerId,["CHAT","GROUP",this._user.sid,chatMsg]);this._trigger("chatMessage",chatMsg,this._user.sid,!!targetpeerId)},Skyway.prototype.sendPrivateMsg=function(data,targetpeerId){var msg_json={cid:this._key,data:data,mid:this._user.sid,rid:this._room.id,sender:this._user.sid,target:targetpeerId?targetpeerId:this._user.sid,type:this.SIG_TYPE.PRIVATE_MSG};this._sendMessage(msg_json),this._trigger("privateMessage",data,this._user.sid,targetpeerId,!0)},Skyway.prototype.sendPublicMsg=function(data){var msg_json={cid:this._key,data:data,mid:this._user.sid,sender:this._user.sid,rid:this._room.id,type:this.SIG_TYPE.PUBLIC_MSG};this._sendMessage(msg_json),this._trigger("publicMessage",data,this._user.sid,!0)},Skyway.prototype.getDefaultStream=function(options){var self=this;self._streamSettings.audio&&self._streamSettings.video||(self._user.info.settings=options,self._parseStreamSettings(options||{audio:null,video:null})),self._user.info.settings=options,self._parseStreamSettings(options);try{window.getUserMedia({audio:self._streamSettings.audio,video:self._streamSettings.video},function(s){self._onUserMediaSuccess(s,self)},function(e){self._onUserMediaError(e,self)})}catch(e){this._onUserMediaError(e,self)}},Skyway.prototype._onUserMediaSuccess=function(stream,self){self._trigger("mediaAccessSuccess",stream),self._user.streams[stream.id]=stream},Skyway.prototype._onUserMediaError=function(e,self){e.message,e.constraintName,self._trigger("mediaAccessError",e.name||e)},Skyway.prototype._processSigMsg=function(message){var msg=JSON.parse(message);if("group"===msg.type)for(var i=0;i<msg.lists.length;i++)this._processSingleMsg(msg.lists[i]);else this._processSingleMsg(msg)},Skyway.prototype._processSingleMsg=function(msg){this._trigger("channelMessage",msg);var origin=msg.mid;if(origin&&origin!==this._user.sid||(origin="Server"),msg.mid!==this._user.sid||msg.type===this.SIG_TYPE.REDIRECT||msg.type===this.SIG_TYPE.IN_ROOM||msg.type===this.SIG_TYPE.CHAT)switch(msg.type){case this.SIG_TYPE.PUBLIC_MSG:this._MsgHandler(msg);break;case this.SIG_TYPE.PRIVATE_MSG:this._privateMsgHandler(msg);break;case this.SIG_TYPE.IN_ROOM:this._inRoomHandler(msg);break;case this.SIG_TYPE.ENTER:this._enterHandler(msg);break;case this.SIG_TYPE.WELCOME:this._welcomeHandler(msg);break;case this.SIG_TYPE.OFFER:this._offerHandler(msg);break;case this.SIG_TYPE.ANSWER:this._answerHandler(msg);break;case this.SIG_TYPE.CANDIDATE:this._candidateHandler(msg);break;case this.SIG_TYPE.BYE:this._byeHandler(msg);break;case this.SIG_TYPE.CHAT:this._chatHandler(msg);break;case this.SIG_TYPE.REDIRECT:this._redirectHandler(msg);break;case this.SIG_TYPE.ERROR:this._errorHandler(msg);break;case this.SIG_TYPE.UPDATE_USER:this._updateUserEventHandler(msg);break;case this.SIG_TYPE.MUTE_VIDEO:this._muteVideoEventHandler(msg);break;case this.SIG_TYPE.MUTE_AUDIO:this._muteAudioEventHandler(msg);break;case this.SIG_TYPE.ROOM_LOCK:this._roomLockEventHandler(msg);break;case this.SIG_TYPE.INVITE:}},Skyway.prototype._chatHandler=function(msg){this._trigger("chatMessage",msg.data,msg.sender,msg.target?!0:!1)},Skyway.prototype._errorHandler=function(msg){},Skyway.prototype._redirectHandler=function(msg){this._trigger("systemAction",msg.action,msg.info)},Skyway.prototype._updateUserEventHandler=function(msg){var targetMid=msg.mid;this._peerInformations[targetMid]&&(msg.displayName&&(this._peerInformations[targetMid].displayName=msg.displayName),msg.data&&(this._peerInformations[targetMid].data=msg.data||{}),this._trigger("peerUpdated",targetMid,this._peerInformations[targetMid]))},Skyway.prototype._roomLockEventHandler=function(msg){msg.mid;this._trigger("roomLock",!0,msg.lock)},Skyway.prototype._muteAudioEventHandler=function(msg){var targetMid=msg.mid;this._peerInformations[targetMid]&&(this._peerInformations[targetMid].media.audio=msg.enabled,this._trigger("peerUpdated",targetMid,this._peerInformations[targetMid]))},Skyway.prototype._muteVideoEventHandler=function(msg){var targetMid=msg.mid;this._peerInformations[targetMid]&&(this._peerInformations[targetMid].media.video=msg.enabled,this._trigger("peerUpdated",targetMid,this._peerInformations[targetMid]))},Skyway.prototype._byeHandler=function(msg){var targetMid=msg.mid;this._removePeer(targetMid)},Skyway.prototype._privateMsgHandler=function(msg){this._trigger("privateMessage",msg.data,msg.sender,msg.target,!1)},Skyway.prototype._publicMsgHandler=function(msg){this._trigger("publicMessage",msg.data,msg.sender,!1)},Skyway.prototype._removePeer=function(peerId){this._trigger("peerLeft",peerId),this._peerConnections[peerId]&&this._peerConnections[peerId].close(),delete this._peerConnections[peerId]},Skyway.prototype._inRoomHandler=function(msg){this._room.pcHelper.pcConfig=this._setFirefoxIceServers(msg.pc_config),this._in_room=!0,this._user.sid=msg.sid,this._trigger("joinedRoom",this._room.id,this._user.sid);var self=this,params={type:self.SIG_TYPE.ENTER,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser.browser,version:window.webrtcDetectedBrowser.version,info:self._user.info};self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER),self._sendMessage(params)},Skyway.prototype._enterHandler=function(msg){var targetMid=msg.mid,self=this;if(!self._peerConnections[targetMid]){msg.agent=msg.agent?msg.agent:"Chrome";var browserAgent=msg.agent+(msg.version?"|"+msg.version:"");checkMediaDataChannelSettings(!1,browserAgent,function(beOfferer){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER,targetMid);var params={type:beOfferer?self.SIG_TYPE.ENTER:self.SIG_TYPE.WELCOME,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser.browser,info:self._user.info};beOfferer||(self._peerInformations[targetMid]=msg.info,self._trigger("peerJoined",targetMid,msg.info),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.WELCOME,targetMid),params.target=targetMid),self._sendMessage(params)})}},Skyway.prototype._welcomeHandler=function(msg){var targetMid=msg.mid;msg.agent=msg.agent?msg.agent:"Chrome",this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.WELCOME,targetMid),this._peerInformations[targetMid]=msg.info,this._trigger("peerJoined",targetMid,msg.info),this._enableIceTrickle=void 0!==typeof msg.enableIceTrickle?msg.enableIceTrickle:this._enableIceTrickle,this._peerConnections[targetMid]||this._openPeer(targetMid,msg.agent,!0,msg.receiveOnly)},Skyway.prototype._offerHandler=function(msg){var targetMid=msg.mid;msg.agent=msg.agent?msg.agent:"Chrome",this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.OFFER,targetMid);var offer=new window.RTCSessionDescription(msg),pc=this._peerConnections[targetMid];pc||(this._openPeer(targetMid,msg.agent,!1),pc=this._peerConnections[targetMid]);var self=this;pc.setRemoteDescription(new RTCSessionDescription(offer),function(){self._doAnswer(targetMid)},function(err){})},Skyway.prototype._doAnswer=function(targetMid){var pc=this._peerConnections[targetMid],self=this;pc&&pc.createAnswer(function(answer){self._setLocalAndSendMessage(targetMid,answer)},function(error){self._onOfferOrAnswerError(targetMid,error,"answer")},self._room.pcHelper.sdpConstraints)},Skyway.prototype._onOfferOrAnswerError=function(targetMid,error,type){},Skyway.prototype._openPeer=function(targetMid,peerAgentBrowser,toOffer,receiveOnly){var self=this;self._peerConnections[targetMid]=self._createPeerConnection(targetMid),receiveOnly||self._addLocalStream(targetMid),toOffer&&self._createDataChannel(targetMid,function(dc){self._dataChannels[targetMid]=dc,self._dataChannelPeers[dc.label]=targetMid,self._checkDataChannelStatus(dc),self._doCall(targetMid,peerAgentBrowser)})},Skyway.prototype._addLocalStream=function(peerId){if(Object.keys(this._user.streams).length>0)for(var stream in this._user.streams)this._user.streams.hasOwnProperty(stream)&&this._peerConnections[peerId].addStream(this._user.streams[stream])},Skyway.prototype._onRemoteStreamAdded=function(targetMid,event){this._trigger("addPeerStream",targetMid,event.stream)},Skyway.prototype._doCall=function(targetMid,peerAgentBrowser){var pc=this._peerConnections[targetMid],constraints=this._room.pcHelper.offerConstraints,sc=this._room.pcHelper.sdpConstraints;for(var name in sc.mandatory)sc.mandatory.hasOwnProperty(name)&&(constraints.mandatory[name]=sc.mandatory[name]);constraints.optional.concat(sc.optional);var self=this;checkMediaDataChannelSettings(!0,peerAgentBrowser,function(offerConstraints){pc.createOffer(function(offer){self._setLocalAndSendMessage(targetMid,offer)},function(error){self._onOfferOrAnswerError(targetMid,error,"offer")},offerConstraints)},constraints)},Skyway.prototype._findSDPLine=function(sdpLines,condition,value){for(var index in sdpLines)if(sdpLines.hasOwnProperty(index))for(var c in condition)if(condition.hasOwnProperty(c)&&0===sdpLines[index].indexOf(c))return sdpLines[index]=value,[index,sdpLines[index]];return[]},Skyway.prototype._addStereo=function(sdpLines){var opusLineFound=!1,opusPayload=0,rtpmapLine=this._findSDPLine(sdpLines,["a=rtpmap:"]);if(rtpmapLine.length&&0===rtpmapLine[1].split(" ")[1].indexOf("opus/48000/")&&(opusLineFound=!0,opusPayload=rtpmapLine[1].split(" ")[0].split(":")[1]),opusLineFound){var fmtpLine=this._findSDPLine(sdpLines,["a=fmtp:"+opusPayload]);fmtpLine.length&&(sdpLines[fmtpLine[0]]=fmtpLine[1]+"; stereo=1")}return sdpLines},Skyway.prototype._setSDPBitrate=function(sdpLines){var bandwidth=this._streamSettings.bandwidth,maLineFound=this._findSDPLine(sdpLines,["m=","a="]).length,cLineFound=this._findSDPLine(sdpLines,["c="]).length;if(maLineFound&&cLineFound){if(bandwidth.audio){var audioLine=this._findSDPLine(sdpLines,["a=mid:audio","m=mid:audio"]);sdpLines.splice(audioLine[0],0,"b=AS:"+bandwidth.audio)}if(bandwidth.video){var videoLine=this._findSDPLine(sdpLines,["a=mid:video","m=mid:video"]);sdpLines.splice(videoLine[0],0,"b=AS:"+bandwidth.video)}if(bandwidth.data){var dataLine=this._findSDPLine(sdpLines,["a=mid:data","m=mid:data"]);sdpLines.splice(dataLine[0],0,"b=AS:"+bandwidth.data)}}return sdpLines},Skyway.prototype._setLocalAndSendMessage=function(targetMid,sessionDescription){var pc=this._peerConnections[targetMid],sdpLines=sessionDescription.sdp.split("\r\n");this._streamSettings.stereo&&this._addStereo(sdpLines),this._streamSettings.bandwidth&&(sdpLines=this._setSDPBitrate(sdpLines,this._streamSettings.bandwidth)),sessionDescription.sdp=sdpLines.join("\r\n");var self=this;pc.setLocalDescription(sessionDescription,function(){self._trigger("handshakeProgress",sessionDescription.type,targetMid),self._enableIceTrickle&&sessionDescription.type!==self.HANDSHAKE_PROGRESS.OFFER&&self._sendMessage({type:sessionDescription.type,sdp:sessionDescription.sdp,mid:self._user.sid,agent:window.webrtcDetectedBrowser.browser,target:targetMid,rid:self._room.id})},function(){})},Skyway.prototype._setFirefoxIceServers=function(config){if(window.webrtcDetectedBrowser.mozWebRTC){for(var newIceServers=[{url:"stun:stun.services.mozilla.com"}],i=0;i<config.iceServers.length;i++){var iceServer=config.iceServers[i],iceServerType=iceServer.url.split(":")[0];if("stun"===iceServerType){if(iceServer.url.indexOf("google"))continue;iceServer.url=[iceServer.url],newIceServers.push(iceServer)}else{var newIceServer={};newIceServer.credential=iceServer.credential,newIceServer.url=iceServer.url.split(":")[0],newIceServer.username=iceServer.url.split(":")[1].split("@")[0],newIceServer.url+=":"+iceServer.url.split(":")[1].split("@")[1],newIceServers.push(newIceServer)}}config.iceServers=newIceServers}return config},Skyway.prototype._waitForMediaStream=function(callback,options){var self=this;if(!options)return void callback();if(options.user&&(self._user.info=options.user||{},delete options.user),options.hasOwnProperty("bandwidth")&&!options.hasOwnProperty("video")&&!options.hasOwnProperty("audio"))return self._parseStreamSettings(options),void callback();if(self._user.info.settings&&self._user.info.settings===options)callback();else{self.getDefaultStream(options);var checkForStream=setInterval(function(){for(var stream in self._user.streams)if(self._user.streams.hasOwnProperty(stream)){var audioTracks=self._user.streams[stream].getAudioTracks(),videoTracks=self._user.streams[stream].getVideoTracks();if((options.video?videoTracks.length>0:!0)&&(options.audio?audioTracks.length>0:!0)){clearInterval(checkForStream),callback();break}}},2e3)}},Skyway.prototype._createPeerConnection=function(targetMid){var pc;try{pc=new window.RTCPeerConnection(this._room.pcHelper.pcConfig,this._room.pcHelper.pcConstraints)}catch(e){return null}var self=this;return pc.ondatachannel=function(event){var dc=event.channel||event;self._createDataChannel(targetMid,function(dc){self._dataChannels[targetMid]=dc,self._dataChannelPeers[dc.label]=targetMid,self._checkDataChannelStatus(dc)},dc)},pc.onaddstream=function(event){self._onRemoteStreamAdded(targetMid,event)},pc.onicecandidate=function(event){self._onIceCandidate(targetMid,event)},pc.oniceconnectionstatechange=function(){checkIceConnectionState(targetMid,pc.iceConnectionState,function(iceConnectionState){self._trigger("iceConnectionState",iceConnectionState,targetMid)})},pc.onsignalingstatechange=function(){var signalingState=pc.signalingState;pc.signalingState!==self.PEER_CONNECTION_STATE.STABLE&&pc.signalingState!==self.PEER_CONNECTION_STATE.CLOSED?pc.hasSetOffer=!0:pc.signalingState===self.PEER_CONNECTION_STATE.STABLE&&pc.hasSetOffer&&(signalingState=self.PEER_CONNECTION_STATE.ESTABLISHED),self._trigger("peerConnectionState",signalingState,targetMid)},pc.onicegatheringstatechange=function(){self._trigger("candidateGenerationState",pc.iceGatheringState,targetMid)},pc},Skyway.prototype._onIceCandidate=function(targetMid,event){if(event.candidate){{var msgCan=event.candidate.candidate.split(" ");msgCan[7]}this._sendMessage({type:this.SIG_TYPE.CANDIDATE,label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate,mid:this._user.sid,target:targetMid,rid:this._room.id})}else if(this._trigger("candidateGenerationState",this.CANDIDATE_GENERATION_STATE.DONE,targetMid),!this._enableIceTrickle){var sessionDescription=this._peerConnections[targetMid].localDescription;this._sendMessage({type:sessionDescription.type,sdp:sessionDescription.sdp,mid:this._user.sid,agent:window.webrtcDetectedBrowser.browser,target:targetMid,rid:this._room.id})}},Skyway.prototype._candidateHandler=function(msg){var targetMid=msg.mid,pc=this._peerConnections[targetMid];if(pc){if(pc.iceConnectionState===this.ICE_CONNECTION_STATE.CONNECTED)return;var msgCan=msg.candidate.split(" "),index=(msgCan[7],msg.label),candidate=new window.RTCIceCandidate({sdpMLineIndex:index,candidate:msg.candidate});pc.addIceCandidate(candidate)}},Skyway.prototype._answerHandler=function(msg){var targetMid=msg.mid;this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.ANSWER,targetMid);var answer=new window.RTCSessionDescription(msg),pc=this._peerConnections[targetMid];pc.setRemoteDescription(new RTCSessionDescription(answer),function(){pc.remotePeerReady=!0},function(err){})},Skyway.prototype._sendMessage=function(message){if(this._channel_open){var msgString=JSON.stringify(message);this._socket.send(msgString)}},Skyway.prototype._openChannel=function(){var self=this,_openChannelImpl=function(readyState){if(2===readyState){self.off("readyStateChange",_openChannelImpl);var ip_signaling=self._room.signalingServer.protocol+"://"+self._room.signalingServer.ip+":"+self._room.signalingServer.port;self._socket=self._socketVersion>=1?io.connect(ip_signaling,{forceNew:!0}):window.io.connect(ip_signaling,{"force new connection":!0}),self._socket=window.io.connect(ip_signaling,{"force new connection":!0}),self._socket.on("connect",function(){self._channel_open=!0,self._trigger("channelOpen")}),self._socket.on("error",function(err){self._channel_open=!1,self._trigger("channelError",err)}),self._socket.on("disconnect",function(){self._trigger("channelClose")}),self._socket.on("message",function(msg){self._processSigMsg(msg)})}};this._channel_open||(0===this._readyState?(this.on("readyStateChange",_openChannelImpl),this._loadInfo(this)):_openChannelImpl(2))},Skyway.prototype._closeChannel=function(){this._channel_open&&(this._socket.disconnect(),this._socket=null,this._channel_open=!1,this._readyState=0)},Skyway.prototype._createDataChannel=function(peerId,callback,dc){var self=this,pc=self._peerConnections[peerId],channel_name=self._user.sid+"_"+peerId;dc?channel_name=dc.label:(!webrtcDetectedBrowser.isSCTPDCSupported&&!webrtcDetectedBrowser.isPluginSupported,dc=pc.createDataChannel(channel_name)),self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.NEW,peerId),dc.onerror=function(err){self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.ERROR,peerId)},dc.onclose=function(){self._closeDataChannel(peerId,self),self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.CLOSED,peerId)},dc.onopen=function(){dc.push=dc.send,dc.send=function(data){dc.push(data)}},dc.onmessage=function(event){self._dataChannelHandler(event.data,peerId,self)},self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.LOADED,peerId),callback(dc)},Skyway.prototype._checkDataChannelStatus=function(dc){var self=this;setTimeout(function(){var peerId=self._dataChannelPeers[dc.label];self._trigger("dataChannelState",dc.readyState,peerId),dc.readyState===self.DATA_CHANNEL_STATE.OPEN&&self._sendDataChannel(peerId,["CONN",dc.label])},500)},Skyway.prototype._sendDataChannel=function(peerId,data){var dc=this._dataChannels[peerId];if(dc&&dc.readyState===this.DATA_CHANNEL_STATE.OPEN)try{for(var dataString="",i=0;i<data.length;i++)dataString+=data[i],dataString+=i!==data.length-1?"|":"";dc.send(dataString)}catch(err){}},Skyway.prototype._dataChannelPeer=function(channel,self){return self._dataChannelPeers[channel]},Skyway.prototype._closeDataChannel=function(peerId,self){var dc=self._dataChannels[peerId];dc&&(dc.readyState!==self.DATA_CHANNEL_STATE.CLOSED&&dc.close(),delete self._dataChannels[peerId],delete self._dataChannelPeers[dc.label])},Skyway.prototype._dataChannelHandler=function(dataString,peerId,self){if("string"==typeof dataString)if(dataString.indexOf("|")>-1&&dataString.indexOf("|")<6){var data=dataString.split("|"),state=data[0];switch(state){case"CONN":self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.OPEN,peerId);break;case"WRQ":self._dataChannelWRQHandler(peerId,data,self);break;case"ACK":self._dataChannelACKHandler(peerId,data,self);break;case"ERROR":self._dataChannelERRORHandler(peerId,data,self);break;case"CHAT":self._dataChannelCHATHandler(peerId,data,self)}}else self._dataChannelDATAHandler(peerId,dataString,self.DATA_TRANSFER_DATA_TYPE.BINARY_STRING,self)},Skyway.prototype._dataChannelWRQHandler=function(peerId,data,self){var itemId=this._user.sid+this.DATA_TRANSFER_TYPE.DOWNLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),name=data[2],binarySize=parseInt(data[3],10),expectedSize=parseInt(data[4],10),timeout=parseInt(data[5],10),sendDataTransfer=this._debug||confirm('Do you want to receive "'+name+'" ?');if(sendDataTransfer){self._downloadDataTransfers[peerId]=[],self._downloadDataSessions[peerId]={itemId:itemId,name:name,size:binarySize,ackN:0,receivedSize:0,chunkSize:expectedSize,timeout:timeout},self._sendDataChannel(peerId,["ACK",0,window.webrtcDetectedBrowser.browser]);var transferInfo={name:name,size:binarySize,senderId:peerId};this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.DOWNLOAD_STARTED,itemId,peerId,transferInfo)}else self._sendDataChannel(peerId,["ACK",-1])},Skyway.prototype._dataChannelACKHandler=function(peerId,data,self){self._clearDataChannelTimeout(peerId,!0,self);var ackN=parseInt(data[1],10),chunksLength=self._uploadDataTransfers[peerId].length,uploadedDetails=self._uploadDataSessions[peerId],itemId=uploadedDetails.itemId,timeout=uploadedDetails.timeout,transferInfo={};if(ackN>-1)if(chunksLength>ackN){var fileReader=new FileReader;fileReader.onload=function(){var base64BinaryString=fileReader.result.split(",")[1];self._sendDataChannel(peerId,[base64BinaryString]),self._setDataChannelTimeout(peerId,timeout,!0,self),transferInfo={percentage:((ackN+1)/chunksLength*100).toFixed()},self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.UPLOADING,itemId,peerId,transferInfo)},fileReader.readAsDataURL(self._uploadDataTransfers[peerId][ackN])}else ackN===chunksLength&&(transferInfo={name:uploadedDetails.name},self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.UPLOAD_COMPLETED,itemId,peerId,transferInfo),delete self._uploadDataTransfers[peerId],delete self._uploadDataSessions[peerId]);else self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.REJECTED,itemId,peerId),delete self._uploadDataTransfers[peerId],delete self._uploadDataSessions[peerId]},Skyway.prototype._dataChannelCHATHandler=function(peerId,data){for(var msgChatType=this._stripNonAlphanumeric(data[1]),msgChat=(this._stripNonAlphanumeric(data[2]),""),i=3;i<data.length;i++)msgChat+=data[i];
var chatDisplay="[DC]: "+msgChat,msg={type:this.SIG_TYPE.CHAT,mid:peerId,sender:peerId,data:chatDisplay};"PRIVATE"===msgChatType&&(msg.target=this._user.sid),this._processSingleMsg(msg)},Skyway.prototype._dataChannelERRORHandler=function(peerId,data,self){var isUploader=data[2],itemId=isUploader?self._uploadDataSessions[peerId].itemId:self._downloadDataSessions[peerId].itemId,transferInfo={message:data[1],type:isUploader?self.DATA_TRANSFER_TYPE.UPLOAD:self.DATA_TRANSFER_TYPE.DOWNLOAD};self._clearDataChannelTimeout(peerId,isUploader,self),self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.ERROR,itemId,peerId,transferInfo)},Skyway.prototype._dataChannelDATAHandler=function(peerId,dataString,dataType,self){var chunk,transferInfo={};self._clearDataChannelTimeout(peerId,!1,self);var transferStatus=self._downloadDataSessions[peerId],itemId=transferStatus.itemId;if(dataType===self.DATA_TRANSFER_DATA_TYPE.BINARY_STRING)chunk=self._base64ToBlob(dataString);else if(dataType===self.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER)chunk=new Blob(dataString);else{if(dataType!==self.DATA_TRANSFER_DATA_TYPE.BLOB)return transferInfo={message:"Unhandled data exception: "+dataType,type:self.DATA_TRANSFER_TYPE.DOWNLOAD},void self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.ERROR,itemId,peerId,transferInfo);chunk=dataString}var receivedSize=chunk.size*(4/3);if(transferStatus.chunkSize>=receivedSize){self._downloadDataTransfers[peerId].push(chunk),transferStatus.ackN+=1,transferStatus.receivedSize+=receivedSize;var totalReceivedSize=transferStatus.receivedSize,percentage=(totalReceivedSize/transferStatus.size*100).toFixed();if(self._sendDataChannel(peerId,["ACK",transferStatus.ackN,self._user.sid]),transferStatus.chunkSize===receivedSize)transferInfo={percentage:percentage},self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.DOWNLOADING,itemId,peerId,transferInfo),self._setDataChannelTimeout(peerId,transferStatus.timeout,!1,self),self._downloadDataTransfers[peerId].info=transferStatus;else{var blob=new Blob(self._downloadDataTransfers[peerId]);transferInfo={data:URL.createObjectURL(blob)},self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.DOWNLOAD_COMPLETED,itemId,peerId,transferInfo),delete self._downloadDataTransfers[peerId],delete self._downloadDataSessions[peerId]}}else transferInfo={message:"Packet not match - [Received]"+receivedSize+" / [Expected]"+transferStatus.chunkSize,type:self.DATA_TRANSFER_TYPE.DOWNLOAD},self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.ERROR,itemId,peerId,transferInfo)},Skyway.prototype._setDataChannelTimeout=function(peerId,timeout,isSender,self){self._dataTransfersTimeout[peerId]||(self._dataTransfersTimeout[peerId]={});var type=isSender?self.DATA_TRANSFER_TYPE.UPLOAD:self.DATA_TRANSFER_TYPE.DOWNLOAD;self._dataTransfersTimeout[peerId][type]=setTimeout(function(){self._dataTransfersTimeout[peerId][type]&&(isSender?(delete self._uploadDataTransfers[peerId],delete self._uploadDataSessions[peerId]):(delete self._downloadDataTransfers[peerId],delete self._downloadDataSessions[peerId]),self._sendDataChannel(peerId,["ERROR","Connection Timeout. Longer than "+timeout+" seconds. Connection is abolished.",isSender]),self._clearDataChannelTimeout(peerId,isSender,self))},1e3*timeout)},Skyway.prototype._clearDataChannelTimeout=function(peerId,isSender,self){if(self._dataTransfersTimeout[peerId]){var type=isSender?self.DATA_TRANSFER_TYPE.UPLOAD:self.DATA_TRANSFER_TYPE.DOWNLOAD;clearTimeout(self._dataTransfersTimeout[peerId][type]),delete self._dataTransfersTimeout[peerId][type]}},Skyway.prototype._base64ToBlob=function(dataURL){for(var byteString=atob(dataURL.replace(/\s\r\n/g,"")),ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),j=0;j<byteString.length;j++)ia[j]=byteString.charCodeAt(j);return new Blob([ab])},Skyway.prototype._chunkFile=function(blob,blobByteSize){var chunksArray=[],startCount=0,endCount=0;if(blobByteSize>this._chunkFileSize){for(;blobByteSize-1>endCount;)endCount=startCount+this._chunkFileSize,chunksArray.push(blob.slice(startCount,endCount)),startCount+=this._chunkFileSize;blobByteSize-(startCount+1)>0&&chunksArray.push(blob.slice(startCount,blobByteSize-1))}else chunksArray.push(blob);return chunksArray},Skyway.prototype._stripNonAlphanumeric=function(str){for(var strOut="",i=0;i<str.length;i++){var curChar=str[i];this._alphanumeric(curChar)&&(strOut+=curChar)}return strOut},Skyway.prototype._alphanumeric=function(str){var letterNumber=/^[0-9a-zA-Z]+$/;return str.match(letterNumber)?!0:!1},Skyway.prototype.sendBlobData=function(data,dataInfo,targetpeerId){if(!data&&!dataInfo)return!1;var noOfPeersSent=0;dataInfo.timeout=dataInfo.timeout||60,dataInfo.itemId=this._user.sid+this.DATA_TRANSFER_TYPE.UPLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".","");var transferInfo={};if(targetpeerId)this._dataChannels.hasOwnProperty(targetpeerId)&&(this._sendBlobDataToPeer(data,dataInfo,targetpeerId),noOfPeersSent=1);else{targetpeerId=this._user.sid;for(var peerId in this._dataChannels)this._dataChannels.hasOwnProperty(peerId)&&(this._sendBlobDataToPeer(data,dataInfo,peerId),noOfPeersSent++)}noOfPeersSent>0?(transferInfo={itemId:dataInfo.itemId,senderId:this._user.sid,name:dataInfo.name,size:dataInfo.size,data:URL.createObjectURL(data)},this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.UPLOAD_STARTED,dataInfo.itemId,targetpeerId,transferInfo)):(transferInfo={message:"No available DataChannels to send Blob data",type:this.DATA_TRANSFER_TYPE.UPLOAD},this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.ERROR,itemId,targetpeerId,transferInfo),this._uploadDataTransfers={},this._uploadDataSessions={})},Skyway.prototype._sendBlobDataToPeer=function(data,dataInfo,peerId){var binarySize=(dataInfo.size*(4/3)).toFixed(),chunkSize=(this._chunkFileSize*(4/3)).toFixed();"Firefox"===window.webrtcDetectedBrowser.browser&&window.webrtcDetectedBrowser.version<30&&(chunkSize=this._mozChunkFileSize),this._uploadDataTransfers[peerId]=this._chunkFile(data,dataInfo.size),this._uploadDataSessions[peerId]={name:dataInfo.name,size:binarySize,itemId:dataInfo.itemId,timeout:dataInfo.timeout},this._sendDataChannel(peerId,["WRQ",window.webrtcDetectedBrowser.browser,dataInfo.name,binarySize,chunkSize,dataInfo.timeout]),this._setDataChannelTimeout(peerId,dataInfo.timeout,!0,this)},Skyway.prototype._handleLock=function(lockAction){var self=this,url=self._serverPath+"/rest/room/lock",params={api:self._apiKey,rid:self._selectedRoom||self._defaultRoom,start:self._room.start,len:self._room.len,cred:self._room.token,action:lockAction,end:new Date(new Date(self._room.start).getTime()+60*self._room.len*60*1e3).toISOString()};self._requestServerInfo("POST",url,function(status,response){return 200!==status?void self._trigger("roomLock",!1,null,"Request failed!"):void(response.status?(self._trigger("roomLock",!0,response.content.lock),lockAction!==self.LOCK_ACTION.STATUS&&self._sendMessage({type:self.SIG_TYPE.ROOM_LOCK,mid:self._user.sid,rid:self._room.id,lock:response.content.lock})):self._trigger("roomLock",!1,null,response.message))},params)},Skyway.prototype._handleAV=function(mediaType,isEnabled,hasMedia){("audio"===mediaType||"video"===mediaType)&&(this._sendMessage({type:"audio"===mediaType?this.SIG_TYPE.MUTE_AUDIO:this.SIG_TYPE.MUTE_VIDEO,mid:this._user.sid,rid:this._room.id,enabled:isEnabled}),hasMedia===!1&&(this.leaveRoom(),this.joinRoom({audio:"audio"===mediaType?!0:this._streamSettings.audio,video:"video"===mediaType?!0:this._streamSettings.video})),this._in_room&&(this._user.info.media[mediaType]=isEnabled,this._trigger("userUpdated",this._user.info)))},Skyway.prototype.lockRoom=function(){this._handleLock(this.LOCK_ACTION.LOCK)},Skyway.prototype.unlockRoom=function(){this._handleLock(this.LOCK_ACTION.UNLOCK)},Skyway.prototype.enableAudio=function(){var hasAudioTracks=!1;for(var stream in this._user.streams)if(this._user.streams.hasOwnProperty(stream)){var tracks=this._user.streams[stream].getAudioTracks();for(var track in tracks)tracks.hasOwnProperty(track)&&(tracks[track].enabled=!0,hasAudioTracks=!0)}this._handleAV("audio",!0,hasAudioTracks)},Skyway.prototype.disableAudio=function(){for(var stream in this._user.streams)if(this._user.streams.hasOwnProperty(stream)){var tracks=this._user.streams[stream].getAudioTracks();for(var track in tracks)tracks.hasOwnProperty(track)&&(tracks[track].enabled=!1)}this._handleAV("audio",!1)},Skyway.prototype.enableVideo=function(){var hasVideoTracks=!1;for(var stream in this._user.streams)if(this._user.streams.hasOwnProperty(stream)){var tracks=this._user.streams[stream].getVideoTracks();for(var track in tracks)tracks.hasOwnProperty(track)&&(tracks[track].enabled=!0,hasVideoTracks=!0)}this._handleAV("video",!0,hasVideoTracks)},Skyway.prototype.disableVideo=function(){for(var stream in this._user.streams)if(this._user.streams.hasOwnProperty(stream)){var tracks=this._user.streams[stream].getVideoTracks();for(var track in tracks)tracks.hasOwnProperty(track)&&(tracks[track].enabled=!1)}this._handleAV("video",!1)},Skyway.prototype._parseStreamSettings=function(options){if(options=options||{},this._streamSettings.bandwidth=options.bandwidth||this._streamSettings.bandwidth||{},"object"==typeof options.video){if("object"==typeof options.video.res){var width=options.video.res.width,height=options.video.res.height,frameRate="number"==typeof options.video.frameRate?options.video.frameRate:50;this._streamSettings.video=width&&height?{mandatory:{minWidth:width,minHeight:height},optional:[{minFrameRate:frameRate}]}:!0}}else options.hasOwnProperty("video")&&(options.video="boolean"==typeof options.video?options.video:!0);"object"==typeof options.audio?(this._streamSettings.audio=!0,this._streamSettings.stereo="boolean"==typeof options.audio.stereo?options.audio.stereo:!1):options.hasOwnProperty("audio")&&(options.audio="boolean"==typeof options.audio?options.audio:!0,this._streamSettings.audio=options.audio),this._user.info.settings.audio=options.audio,this._user.info.settings.video=options.video,this._user.info.media={audio:options.audio?!0:!1,video:options.video?!0:!1}},Skyway.prototype.joinRoom=function(room,mediaOptions){if(!this._in_room){var self=this,doJoinRoom=function(){self._waitForMediaStream(function(){var _sendJoinRoomMsg=function(){self.off("channelOpen",_sendJoinRoomMsg),self._sendMessage({type:self.SIG_TYPE.JOIN_ROOM,uid:self._user.id,cid:self._key,rid:self._room.id,userCred:self._user.token,timeStamp:self._user.timeStamp,apiOwner:self._user.apiOwner,roomCred:self._room.token,start:self._room.start,len:self._room.len})};self._channel_open?_sendJoinRoomMsg():(self.on("channelOpen",_sendJoinRoomMsg),self._openChannel())},mediaOptions)};"string"==typeof room?self._reinit(doJoinRoom,{room:room}):(mediaOptions=room,doJoinRoom())}},Skyway.prototype.leaveRoom=function(){if(this._in_room){for(var pc_index in this._peerConnections)this._peerConnections.hasOwnProperty(pc_index)&&this._removePeer(pc_index);this._in_room=!1,this._closeChannel()}}}).call(this);